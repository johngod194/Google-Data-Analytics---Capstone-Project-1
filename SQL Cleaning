/****** Google-Data-Analytics-Capstione-project  ******/

##sql cleaning process
-- create a table cyclistic_24_clean_nulls from cyclistic_24 WHERE there are no rows with NULLS
CREATE TABLE
  `alien-array-468815-r3`.`Cyclistic`.`cyclistic_24_clean_nulls` AS
SELECT
  ride_id,
  rideable_type,
  started_at,
  ended_at,
  start_station_name,
  start_station_id,
  end_station_name,
  end_station_id,
  start_lat,
  start_lng,
  end_lat,
  end_lng,
  member_casual
FROM
  `alien-array-468815-r3`.`Cyclistic`.`cyclistic_24`
WHERE
  ride_id IS NOT NULL
  AND rideable_type IS NOT NULL
  AND started_at IS NOT NULL
  AND ended_at IS NOT NULL
  AND start_station_name IS NOT NULL
  AND start_station_id IS NOT NULL
  AND end_station_name IS NOT NULL
  AND end_station_id IS NOT NULL
  AND start_lat IS NOT NULL
  AND start_lng IS NOT NULL
  AND end_lat IS NOT NULL
  AND end_lng IS NOT NULL
  AND member_casual IS NOT NULL;

--removing nulls and duplicates from 5860568 to 4208309 (1,652,259 lines eliminated)

-- checking for duplicated ride_ids
SELECT
  t1.*
FROM
  `alien-array-468815-r3`.`Cyclistic`.`cyclistic_24_clean_nulls` AS t1
INNER JOIN (
  SELECT
    ride_id
  FROM
    `alien-array-468815-r3`.`Cyclistic`.`cyclistic_24_clean_nulls`
  GROUP BY
    ride_id
  HAVING
    COUNT(ride_id) > 1 ) AS t2
ON
  t1.ride_id = t2.ride_id;

--242 duplicate ride_ids were found


--eliminating duplicate ride ids with started_at format that includes microseconds
CREATE OR REPLACE TABLE `alien-array-468815-r3.Cyclistic.cyclistic_24_clean_nulls_unique` AS
SELECT
  *
EXCEPT(row_number)
FROM (
  SELECT
    *,
    ROW_NUMBER() OVER (
      PARTITION BY ride_id
      ORDER BY
        REGEXP_CONTAINS(CAST(started_at AS STRING), r'\\.\\d') ASC,  -- clean format first
        started_at ASC
    ) AS row_number
  FROM
    `alien-array-468815-r3.Cyclistic.cyclistic_24_clean_nulls`
)
WHERE
  row_number = 1;

--unique ride ids - 4208188 (121 lines eliminated)

--amending format from both started_at and ended_at fields to remove microseconds
--sorting by started_at
CREATE OR REPLACE TABLE `alien-array-468815-r3.Cyclistic.cyclistic_24_clean_nulls_unique_v1` AS
SELECT
  ride_id,
  FORMAT_TIMESTAMP('%Y-%m-%d %H:%M:%S %Z', started_at) AS started_at,
  FORMAT_TIMESTAMP('%Y-%m-%d %H:%M:%S %Z', ended_at) AS ended_at,
  rideable_type,
  start_station_name,
  start_station_id,
  end_station_name,
  end_station_id,
  start_lat,
  start_lng,
  end_lat,
  end_lng,
  member_casual
FROM
  `alien-array-468815-r3`.`Cyclistic`.`cyclistic_24_clean_nulls_unique_v1`
ORDER BY
  started_at;
